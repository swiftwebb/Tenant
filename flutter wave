settings.py
FLW_PUBLIC_KEY = "FLWPUBK_TEST-xxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
FLW_SECRET_KEY = "FLWSECK_TEST-xxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
FLW_BASE_URL = "https://api.flutterwave.com/v3"



views.py
import requests
from django.conf import settings

def create_flw_subaccount(tenant_name, account_bank, account_number):
    """Creates a Flutterwave subaccount for a tenant (vendor)"""
    url = f"{settings.FLW_BASE_URL}/subaccounts"
    headers = {
        "Authorization": f"Bearer {settings.FLW_SECRET_KEY}",
        "Content-Type": "application/json"
    }
    data = {
        "account_bank": account_bank,  # e.g. "044" for Access Bank
        "account_number": account_number,
        "business_name": tenant_name,
        "split_type": "percentage",
        "split_value": 97.5  # tenant receives 97.5%
    }
    response = requests.post(url, headers=headers, json=data)
    return response.json()




response={
  "status": "success",
  "data": {
    "subaccount_id": "RS_8A35B2E74C63C...",
    "account_number": "1234567890",
    "bank_name": "Access Bank",
    "business_name": "ShopX Store"
  }
}
Store the returned "subaccount_id" in your tenant’s model.






import requests, uuid
from django.conf import settings
from django.shortcuts import redirect
from django.http import HttpResponse

def flutterwave_payment(request, subaccount_id):
    """Initialize a payment with split"""
    tx_ref = str(uuid.uuid4())
    amount = 10000  # ₦100.00 (amount in naira)
    currency = "NGN"
    redirect_url = "http://127.0.0.1:8000/flutterwave/verify/"

    headers = {
        "Authorization": f"Bearer {settings.FLW_SECRET_KEY}",
        "Content-Type": "application/json"
    }

    data = {
        "tx_ref": tx_ref,
        "amount": amount,
        "currency": currency,
        "redirect_url": redirect_url,
        "payment_options": "card, banktransfer",
        "customer": {
            "email": "user@example.com",
            "name": "Test User"
        },
        "customizations": {
            "title": "Baxting Payment",
            "description": "Payment for order",
        },
        "subaccounts": [
            {
                "id": subaccount_id,  # tenant’s Flutterwave subaccount ID
                "transaction_split_ratio": 97.5
            },
            {
                "id": "MAIN_PLATFORM",  # your own subaccount ID
                "transaction_split_ratio": 2.5
            }
        ]
    }

    response = requests.post(f"{settings.FLW_BASE_URL}/payments", json=data, headers=headers)
    res_data = response.json()

    if res_data.get("status") == "success":
        link = res_data["data"]["link"]
        return redirect(link)
    else:
        return HttpResponse("Error initializing payment.")





def verify_flutterwave_payment(request):
    transaction_id = request.GET.get('transaction_id')
    url = f"{settings.FLW_BASE_URL}/transactions/{transaction_id}/verify"
    headers = {"Authorization": f"Bearer {settings.FLW_SECRET_KEY}"}
    response = requests.get(url, headers=headers)
    res_data = response.json()

    if res_data["status"] == "success" and res_data["data"]["status"] == "successful":
        return HttpResponse("✅ Payment successful and split sent.")
    else:
        return HttpResponse("❌ Payment failed or unverified.")


