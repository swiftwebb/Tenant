{% extends "base.html" %}
{% block content %}

<style>
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes shimmer {
    0% { background-position: -1000px 0; }
    100% { background-position: 1000px 0; }
  }
  
  .animate-fadeIn {
    animation: fadeIn 0.6s ease-out;
  }
  
  .stat-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
  }
  
  .gradient-border {
    position: relative;
    background: linear-gradient(white, white) padding-box,
                linear-gradient(135deg, #667eea 0%, #764ba2 100%) border-box;
    border: 2px solid transparent;
  }
  
  .dark .gradient-border {
    background: linear-gradient(#1e293b, #1e293b) padding-box,
                linear-gradient(135deg, #667eea 0%, #764ba2 100%) border-box;
  }
  
  .chart-container {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
  }
</style>

<main class="px-4 sm:px-6 lg:px-10 py-8 bg-gradient-to-br from-gray-50 via-blue-50/30 to-purple-50/30 dark:from-gray-900 dark:via-blue-900/10 dark:to-purple-900/10 min-h-screen">
  <div class="max-w-7xl mx-auto space-y-8">

    <!-- Header Section -->
    <div class="animate-fadeIn bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-3xl p-8 shadow-xl border border-gray-200/50 dark:border-gray-700/50">
      <div class="flex flex-wrap justify-between items-start gap-6">
        <div class="flex-1">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center shadow-lg">
              <span class="material-symbols-outlined text-white text-3xl">analytics</span>
            </div>
            <div>
              <h1 class="text-4xl font-black text-gray-900 dark:text-white">Sales Overview</h1>
              <p class="text-lg text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-purple-600 font-semibold">
                Track Your Total Profit
              </p>
            </div>
          </div>
          <p class="text-gray-600 dark:text-gray-400 text-base ml-[68px]">
            View, manage, and track all customer sales in one place with detailed analytics.
          </p>
        </div>
        
        <div class="flex flex-wrap gap-3">
          <a href="{% url 'customers:dashboard' %}">
            <button class="inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl text-sm font-bold text-gray-700 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600 transition-all duration-200 shadow-md hover:shadow-lg hover:scale-105">
              <span class="material-symbols-outlined text-xl">arrow_back</span>
              <span>Go Back</span>
            </button>
          </a>
          
          <a href="{% url 'customers:sale_create' %}"> 
            <button class="inline-flex items-center justify-center gap-2 px-6 py-3 rounded-xl text-sm font-bold text-white bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105">
              <span class="material-symbols-outlined text-xl">add_circle</span>
              <span>Add Sales</span>
            </button>
          </a>
        </div>
      </div>
    </div>

    <!-- Controls Section -->
    <div class="animate-fadeIn bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-3xl p-6 shadow-xl border border-gray-200/50 dark:border-gray-700/50" style="animation-delay: 0.1s;">
      <div class="flex items-center gap-3 mb-4">
        <span class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-2xl">tune</span>
        <h2 class="text-xl font-bold text-gray-900 dark:text-white">Filters & Controls</h2>
      </div>
      
      <div class="flex flex-wrap gap-4 items-center">
        <div class="flex gap-3">
          <button id="btn-year" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl font-semibold hover:from-blue-600 hover:to-blue-700 transition-all shadow-md hover:shadow-lg hover:scale-105 flex items-center gap-2">
            <span class="material-symbols-outlined text-xl">calendar_view_month</span>
            Show Year
          </button>
          <button id="btn-month" class="px-6 py-3 bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-xl font-semibold hover:from-purple-600 hover:to-purple-700 transition-all shadow-md hover:shadow-lg hover:scale-105 flex items-center gap-2">
            <span class="material-symbols-outlined text-xl">calendar_today</span>
            Show Month
          </button>
        </div>

        <div class="h-8 w-px bg-gray-300 dark:bg-gray-600"></div>

        <label class="flex items-center gap-3 bg-gray-50 dark:bg-gray-700/50 px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-600">
          <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">event</span>
          <span class="text-gray-700 dark:text-gray-300 font-medium">Year:</span>
          <input id="input-year" type="number" min="2000" max="2100" value="{{ today.year }}"
                 class="w-24 px-3 py-1 border-2 border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 dark:text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all">
        </label>

        <label id="month-label" class="flex items-center gap-3 bg-gray-50 dark:bg-gray-700/50 px-4 py-3 rounded-xl border border-gray-200 dark:border-gray-600 hidden">
          <span class="material-symbols-outlined text-gray-600 dark:text-gray-400">date_range</span>
          <span class="text-gray-700 dark:text-gray-300 font-medium">Month:</span>
          <input id="input-month" type="month" value="{{ today|date:'Y-m' }}"
                 class="px-3 py-1 border-2 border-gray-200 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-800 dark:text-white focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all">
        </label>

        <button id="btn-refresh" class="px-6 py-3 bg-gradient-to-r from-emerald-500 to-teal-600 text-white rounded-xl font-semibold hover:from-emerald-600 hover:to-teal-700 transition-all shadow-md hover:shadow-lg hover:scale-105 flex items-center gap-2">
          <span class="material-symbols-outlined text-xl">refresh</span>
          Refresh
        </button>
      </div>
    </div>

    <!-- Chart Section -->
    <div class="animate-fadeIn chart-container rounded-3xl p-8 shadow-xl border-2 border-gray-200/50 dark:border-gray-700/50 backdrop-blur-sm" style="animation-delay: 0.2s;">
      <div class="flex items-center gap-3 mb-6">
        <span class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-3xl">show_chart</span>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Sales Analytics</h2>
      </div>
      <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-inner">
        <canvas id="ordersChart" width="900" height="400"></canvas>
      </div>
    </div>

    <!-- Desktop Table -->
    <div class="hidden md:block animate-fadeIn gradient-border rounded-3xl overflow-hidden shadow-2xl" style="animation-delay: 0.3s;">
      <div class="bg-gradient-to-r from-blue-600 to-purple-600 px-6 py-4">
        <h2 class="text-xl font-bold text-white flex items-center gap-2">
          <span class="material-symbols-outlined text-2xl">table_chart</span>
          Sales Records
        </h2>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse bg-white dark:bg-gray-800">
          <thead class="bg-gradient-to-r from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-750">
            <tr>
              <th class="p-5 text-sm font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider">
                <span class="material-symbols-outlined text-lg">event</span>
              </th>
              <th class="p-5 text-sm font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Date</th>
              <th class="p-5 text-sm font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Order ID</th>
              <th class="p-5 text-sm font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider">Items</th>
              <th class="p-5 text-sm font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider text-right">Net Sales</th>
              <th class="p-5 text-sm font-bold text-gray-700 dark:text-gray-300 uppercase tracking-wider text-right">Actions</th>
            </tr>
          </thead>
          <tbody id="sales-table-body" class="divide-y divide-gray-200 dark:divide-gray-700">
            <!-- JS populates rows -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Mobile Cards -->
    <div class="md:hidden space-y-4 animate-fadeIn" id="sales-cards" style="animation-delay: 0.3s;">
      <!-- JS populates mobile cards -->
    </div>

    <!-- Pagination -->
    <div class="flex flex-wrap justify-center items-center gap-2 p-6 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm rounded-3xl shadow-xl" id="sales-pagination"></div>

  </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
const ctx = document.getElementById('ordersChart').getContext('2d');
let chart = null;
let currentView = 'year';
let currentPage = 1;
const pageSize = 30;

function formatCurrency(n) {
  return new Intl.NumberFormat('en-NG', { style:'currency', currency:'NGN', maximumFractionDigits:2 }).format(n);
}

function renderChart(labels, dataArr, view, year, month) {
  const labelText = view === 'month'
    ? `Daily totals for ${year}-${String(month).padStart(2,'0')}`
    : `Monthly totals for ${year}`;

  const data = {
    labels,
    datasets: [{
      label: labelText,
      data: dataArr,
      backgroundColor: 'rgba(59, 130, 246, 0.8)',
      borderColor: 'rgba(59, 130, 246, 1)',
      borderWidth: 2,
      borderRadius: 8,
      hoverBackgroundColor: 'rgba(147, 51, 234, 0.8)',
    }]
  };

  const options = {
    responsive: true,
    plugins: {
      legend: {
        labels: {
          font: { size: 14, weight: 'bold' },
          color: '#374151'
        }
      },
      tooltip: {
        backgroundColor: 'rgba(0, 0, 0, 0.9)',
        titleFont: { size: 14, weight: 'bold' },
        bodyFont: { size: 13 },
        padding: 12,
        cornerRadius: 8,
        callbacks: {
          label: function(ctx) {
            return formatCurrency(ctx.parsed.y || ctx.parsed);
          }
        }
      }
    },
    scales: {
      y: { 
        beginAtZero: true, 
        ticks: { 
          callback: value => formatCurrency(value),
          font: { size: 12 },
          color: '#6b7280'
        },
        grid: { color: 'rgba(0, 0, 0, 0.05)' }
      },
      x: {
        ticks: {
          font: { size: 12 },
          color: '#6b7280'
        },
        grid: { display: false }
      }
    }
  };

  if (chart) chart.destroy();
  chart = new Chart(ctx, { type: 'bar', data, options });
}

async function loadData() {
  const year = document.getElementById('input-year').value;
  let month = null;
  if (currentView === 'month') {
    const monthVal = document.getElementById('input-month').value;
    const parts = monthVal.split('-');
    if (parts.length === 2) month = parseInt(parts[1]);
  }

  let chartUrl = `/dashboard/chart/data/?view=${currentView}&year=${year}`;
  if (month) chartUrl += `&month=${month}`;
  const chartResp = await fetch(chartUrl, { credentials: 'same-origin' });
  const chartJson = await chartResp.json();
  renderChart(chartJson.labels, chartJson.data, chartJson.view, chartJson.year, chartJson.month);

  loadSalesTable(currentView, year, month, currentPage);
}

async function loadSalesTable(view, year, month=null, page=1) {
  currentPage = page;
  let url = `/dashboard/chart/table-data/?view=${view}&year=${year}&page=${page}&page_size=${pageSize}`;
  if(month) url += `&month=${month}`;

  const resp = await fetch(url, { credentials: 'same-origin' });
  const json = await resp.json();

  // Desktop table
  const tbody = document.getElementById('sales-table-body');
  tbody.innerHTML = '';
  json.rows.forEach((row, index) => {
    const tr = document.createElement('tr');
    tr.className = 'hover:bg-blue-50 dark:hover:bg-gray-700/50 transition-all duration-200 border-b border-gray-100 dark:border-gray-700';
    tr.style.animation = `fadeIn 0.3s ease-out ${index * 0.05}s backwards`;
    tr.innerHTML = `
      <td class="p-5">
        <div class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-100 to-purple-100 dark:from-blue-900/50 dark:to-purple-900/50 flex items-center justify-center">
          <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">receipt</span>
        </div>
      </td>
      <td class="p-5 font-semibold text-gray-900 dark:text-white">${row.date}</td>
      <td class="p-5 text-blue-600 dark:text-blue-400 font-medium">#${row.gross_sales}</td>
      <td class="p-5 text-gray-700 dark:text-gray-300">${row.orders}</td>
      <td class="p-5 text-right font-bold text-emerald-600 dark:text-emerald-400">₦${row.net_sales}</td>
      <td class="p-5 text-right">
        <div class="flex items-center justify-end gap-3">
          <a href="/dashboard/chart/sales_detail_d/${row.id}/" title="View"
             class="p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-blue-100 dark:hover:bg-blue-900/30 hover:text-blue-600 dark:hover:text-blue-400 transition-all">
            <span class="material-symbols-outlined">visibility</span>
          </a>
          <a href="/dashboard/chart/sale_edit_d/${row.id}" title="Edit"
             class="p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-purple-100 dark:hover:bg-purple-900/30 hover:text-purple-600 dark:hover:text-purple-400 transition-all">
            <span class="material-symbols-outlined">edit</span>
          </a>
          <a href="/dashboard/chart/dashboard_delete_sale/${row.id}/" title="Delete"
             class="p-2 rounded-lg text-gray-600 dark:text-gray-400 hover:bg-red-100 dark:hover:bg-red-900/30 hover:text-red-600 dark:hover:text-red-400 transition-all">
            <span class="material-symbols-outlined">delete</span>
          </a>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Mobile cards
  const cardsContainer = document.getElementById('sales-cards');
  cardsContainer.innerHTML = '';
  json.rows.forEach((row, index) => {
    const card = document.createElement('div');
    card.className = 'gradient-border rounded-2xl p-6 shadow-lg hover:shadow-2xl transition-all duration-300 hover:-translate-y-1';
    card.style.animation = `fadeIn 0.3s ease-out ${index * 0.05}s backwards`;
    card.innerHTML = `
      <div class="flex justify-between items-start mb-4">
        <div class="flex-1">
          <div class="flex items-center gap-2 mb-2">
            <span class="material-symbols-outlined text-blue-600 dark:text-blue-400">event</span>
            <p class="font-bold text-gray-900 dark:text-white">${row.date}</p>
          </div>
          <p class="text-blue-600 dark:text-blue-400 text-sm font-medium mb-1">Order #${row.gross_sales}</p>
          <p class="text-gray-600 dark:text-gray-400 text-sm flex items-center gap-1">
            <span class="material-symbols-outlined text-sm">inventory_2</span>
            Items: ${row.orders}
          </p>
        </div>
        <div class="text-right">
          <p class="text-xs text-gray-500 dark:text-gray-400 mb-1">Net Sales</p>
          <p class="text-2xl font-black text-emerald-600 dark:text-emerald-400">₦${row.net_sales}</p>
        </div>
      </div>
      <div class="flex justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-700">
        <a href="/dashboard/chart/sales_detail_d/${row.id}/"
           class="p-3 rounded-xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-900/50 transition-all">
          <span class="material-symbols-outlined">visibility</span>
        </a>
        <a href="/dashboard/chart/sale_edit_d/${row.id}/"
           class="p-3 rounded-xl bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400 hover:bg-purple-200 dark:hover:bg-purple-900/50 transition-all">
          <span class="material-symbols-outlined">edit</span>
        </a>
        <a href="/dashboard/chart/dashboard_delete_sale/${row.id}/"
           class="p-3 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-900/50 transition-all">
          <span class="material-symbols-outlined">delete</span>
        </a>
      </div>
    `;
    cardsContainer.appendChild(card);
  });

  // Pagination
  const pagination = document.getElementById('sales-pagination');
  pagination.innerHTML = '';
  const totalPages = Math.ceil(json.total / pageSize);

  const prevBtn = document.createElement('button');
  prevBtn.innerHTML = '<span class="material-symbols-outlined">chevron_left</span>';
  prevBtn.disabled = currentPage === 1;
  prevBtn.className = `px-4 py-2 rounded-xl font-semibold transition-all ${currentPage === 1 ? 'bg-gray-200 dark:bg-gray-700 text-gray-400 cursor-not-allowed' : 'bg-gradient-to-r from-blue-500 to-purple-600 text-white hover:from-blue-600 hover:to-purple-700 shadow-md hover:shadow-lg hover:scale-105'}`;
  prevBtn.addEventListener('click', () => { if(currentPage>1) loadSalesTable(view, year, month, currentPage-1); });
  pagination.appendChild(prevBtn);

  for(let i=1;i<=totalPages;i++){
    if(i===1 || i===totalPages || (i>=currentPage-2 && i<=currentPage+2)){
      const btn = document.createElement('button');
      btn.textContent = i;
      btn.className = i===currentPage 
        ? 'px-4 py-2 rounded-xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg' 
        : 'px-4 py-2 rounded-xl font-semibold bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600 transition-all hover:scale-105';
      btn.addEventListener('click',()=>loadSalesTable(view,year,month,i));
      pagination.appendChild(btn);
    } else if(i===currentPage-3 || i===currentPage+3){
      const dots = document.createElement('span');
      dots.textContent = '...';
      dots.className = 'px-2 text-gray-500';
      pagination.appendChild(dots);
    }
  }

  const nextBtn = document.createElement('button');
  nextBtn.innerHTML = '<span class="material-symbols-outlined">chevron_right</span>';
  nextBtn.disabled = currentPage === totalPages;
  nextBtn.className = `px-4 py-2 rounded-xl font-semibold transition-all ${currentPage === totalPages ? 'bg-gray-200 dark:bg-gray-700 text-gray-400 cursor-not-allowed' : 'bg-gradient-to-r from-blue-500 to-purple-600 text-white hover:from-blue-600 hover:to-purple-700 shadow-md hover:shadow-lg hover:scale-105'}`;
  nextBtn.addEventListener('click',()=>{ if(currentPage<totalPages) loadSalesTable(view,year,month,currentPage+1); });
  pagination.appendChild(nextBtn);
}

document.getElementById('btn-year').addEventListener('click', () => { currentView='year'; document.getElementById('month-label').classList.add('hidden'); currentPage=1; loadData(); });
document.getElementById('btn-month').addEventListener('click', () => { currentView='month'; document.getElementById('month-label').classList.remove('hidden'); currentPage=1; loadData(); });
document.getElementById('btn-refresh').addEventListener('click',()=>{currentPage=1;loadData();});

loadData();
</script>
{% endblock %}