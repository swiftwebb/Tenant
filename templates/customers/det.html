{% extends 'base.html' %}
{% load static %}
{% load widget_tweaks %}
{% block content %}

<body class="bg-gray-50 dark:bg-gray-900 font-display text-gray-900 dark:text-gray-100">
  <div class="flex flex-col items-center justify-center min-h-screen py-10 px-6">
    <div class="w-full max-w-3xl bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-8">

      <!-- Header -->
      <div class="mb-8 text-center">
        <h1 class="text-3xl font-extrabold mb-2">Tell Us About Your Business</h1>
        <p class="text-gray-500 dark:text-gray-400">
          Fill out your business details below to continue.
        </p>
      </div>

      <!-- ✅ Django messages -->
      {% if messages %}
        <div class="space-y-2 mb-6">
          {% for message in messages %}
            <div class="p-4 rounded-lg 
              {% if message.tags == 'error' %}
                bg-red-50 border border-red-300 text-red-700
              {% elif message.tags == 'success' %}
                bg-green-50 border border-green-300 text-green-700
              {% else %}
                bg-gray-50 border border-gray-300 text-gray-700
              {% endif %}
            ">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Form -->
      <form method="POST" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}

        {% if form.errors %}
        <div class="mb-4 p-4 bg-red-50 border border-red-300 text-red-700 rounded-lg">
          <h3 class="font-semibold">There are errors in the form:</h3>
          <ul class="mt-2 text-sm">
            {% for field, errors in form.errors.items %}
              <li><strong>{{ field }}:</strong> {{ errors|join:", " }}</li>
            {% endfor %}
          </ul>
        </div>
        {% endif %}

        <!-- Business Info -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="id_business_name" class="block text-sm font-semibold mb-2">Business Name</label>
            {{ form.business_name }}
            {% if form.business_name.errors %}
              <p class="mt-2 text-sm text-red-600">{{ form.business_name.errors.0 }}</p>
            {% endif %}
          </div>
          <div>
            <label for="id_Tagline" class="block text-sm font-semibold mb-2">Tagline(optional)</label>
            {{ form.Tagline }}
            {% if form.Tagline.errors %}
              <p class="mt-2 text-sm text-red-600">{{ form.Tagline.errors.0 }}</p>
            {% endif %}
          </div>
        </div>

        <div>
          <label for="id_business_description" class="block text-sm font-semibold mb-2">Business Description</label>
          {{ form.business_description }}
          {% if form.business_description.errors %}
            <p class="mt-2 text-sm text-red-600">{{ form.business_description.errors.0 }}</p>
          {% endif %}
        </div>


        {% if form.business_logistics %}
        <div>
          <label for="id_business_logistics" class="block text-sm font-semibold mb-2">Logistics Provider for Customer Deliveries and Coverage Areas (e.g., Uber – Lagos only)</label>
          {{ form.business_logistics }}
          {% if form.business_logistics.errors %}
            <p class="mt-2 text-sm text-red-600">{{ form.business_logistics.errors.0 }}</p>
          {% endif %}
        </div>
        {%endif%}


        {% if form.business_working_hours %}
        <div>
          <label for="id_business_working_hours" class="block text-sm font-semibold mb-2">Business working hours </label>
          {{ form.business_working_hours }}
          {% if form.business_working_hours.errors %}
            <p class="mt-2 text-sm text-red-600">{{ form.business_working_hours.errors.0 }}</p>
          {% endif %}
        </div>
        {%endif%}

        {% if form.street_address %}
        <!-- Address -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="id_street_address" class="block text-sm font-semibold mb-2">Street Address</label>
            {{ form.street_address }}
          </div>
          <div>
            <label for="id_apartment_address" class="block text-sm font-semibold mb-2">Apartment Address (optional)</label>
            {{ form.apartment_address }}
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div>
            <label for="id_city" class="block text-sm font-semibold mb-2">City</label>
            {{ form.city }}
          </div>
          <div>
            <label for="id_state" class="block text-sm font-semibold mb-2">State</label>
            {{ form.state }}
          </div>

        </div>
        {%endif%}

        <!-- Contact -->
        <div>
          <label for="id_phone_number" class="block text-sm font-semibold mb-2">Business Whatsapp Phone Number</label>
          {{ form.phone_number }}
          {% if form.phone_number.errors %}
            <p class="mt-2 text-sm text-red-600">{{ form.phone_number.errors.0 }}</p>
          {% endif %}
        </div>


        {% if form.bank %}

        <!-- Bank Info -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

          <!-- Info / Note Box -->
          <div class="md:col-span-3">
            <div class="rounded-lg border border-yellow-300 bg-yellow-50 p-4 text-sm text-yellow-900 dark:border-yellow-600 dark:bg-yellow-900/20 dark:text-yellow-200">
              {% if jtype == "Store" %}
              <p class="font-semibold mb-1">Service Fee Notice</p>
              <p>
                A 112.5% service fee applies to every transaction made on your website.
                For example, if a customer purchases a product priced at ₦10,000, you will receive ₦9,750 to your account,
                while ₦250 is deducted as a service charge.
              </p>
              <p class="mt-2">
                This fee covers website maintenance and ongoing support. We recommend slightly adjusting
                your product prices if necessary.
              </p>
              {% else %}
              <p class="font-semibold mb-1">Service Fee Notice</p>
              <p>
                A 10% maintenance fee is applied to advertising revenue generated on your blog.

                This fee covers website maintenance, hosting, and ongoing technical support.
                
                Example:
                If your blog generates ₦100,000 in ad revenue, a ₦10,000 maintenance fee will be deducted, and ₦90,000 will be paid directly into your account.
                
                We are committed to keeping your blog running smoothly while ensuring transparent and timely payouts.
              </p>
              <p class="mt-2">
                This fee covers website maintenance and ongoing support. 
              </p>


              {%endif%}
            </div>
          </div>
        
          <!-- Bank -->
          <div>
            <label for="id_bank" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Bank
            </label>
            {{ form.bank }}
          </div>
        
          <!-- Account Number -->
          <div>
            <label for="id_account_no" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Account Number
            </label>
            {{ form.account_no }}
          </div>
        
          <!-- Account Name -->
          <div>
            <label for="id_account_name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Account Name
            </label>
            {{ form.account_name }}
        
            {% if form.account_name.errors %}
              <p class="mt-2 text-sm text-red-600">
                {{ form.account_name.errors.0 }}
              </p>
            {% endif %}
        
            <!-- ✅ Verified Account Name Box -->
            <div id="account-name-box"
              class="hidden mt-3 p-3 rounded-lg bg-green-50 dark:bg-green-900/20
                     text-green-800 dark:text-green-200 border border-green-300
                     dark:border-green-600 transition-all duration-300 ease-in-out">
              <span class="font-semibold">Verified Account Name:</span>
              <span id="resolved-account-name" class="ml-2"></span>
            </div>
          </div>
        
        </div>
        {%endif%}
        

        <!-- Logo Upload -->
        <div>
          <label for="id_logo" class="block text-sm font-semibold mb-2">Upload Logo (optional)</label>
          
          <!-- Preview -->
          <img id="logo-preview" 
               src="{% if form.instance.logo %}{{ form.instance.logo.url }}{% endif %}" 
               class="w-32 h-32 object-cover rounded-md mb-2 {% if not form.instance.logo %}hidden{% endif %}">
          {% if not form.instance.logo %}
            <p id="no-logo-text" class="text-gray-500 dark:text-gray-400">No logo uploaded yet.</p>
          {% endif %}
        
          <!-- Actual File Input -->
          {{ form.logo|add_class:"hidden" }}
        
          <!-- Custom Upload Button -->
          <label for="{{ form.logo.id_for_label }}" 
                 class="cursor-pointer inline-block bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 px-4 py-2 rounded hover:bg-gray-300 dark:hover:bg-gray-600">
            Upload Logo
          </label>
        </div>
        {% if form.business_picture %}
        <div>
          <label for="id_business_picture" class="block text-sm font-semibold mb-2">Upload a picture of yourself or your business (optional)</label>
        
          <!-- Preview -->
          <img id="business-picture-preview" 
               src="{% if form.instance.business_picture %}{{ form.instance.business_picture.url }}{% endif %}" 
               class="w-32 h-32 object-cover rounded-md mb-2 {% if not form.instance.business_picture %}hidden{% endif %}">
          {% if not form.instance.business_picture %}
            <p id="no-picture-text" class="text-gray-500 dark:text-gray-400">No picture uploaded yet.</p>
          {% endif %}
        
          <!-- Actual File Input -->
          {{ form.business_picture|add_class:"hidden" }}
        
          <!-- Custom Upload Button -->
          <label for="{{ form.business_picture.id_for_label }}" 
                 class="cursor-pointer inline-block bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-100 px-4 py-2 rounded hover:bg-gray-300 dark:hover:bg-gray-600">
            Upload Picture
          </label>
        </div>
        {% else %}
        {% endif %}


        {% if form.tiktok %}
        <div>
          <label for="id_tiktok" class="block text-sm font-semibold mb-2">Business Tiktok Link (Optional) – Display on your website if provided</label>
          {{ form.tiktok }}
          {% if form.tiktok.errors %}
            <p class="mt-2 text-sm text-red-600">{{ form.tiktok.errors.0 }}</p>
          {% endif %}
        </div>
        {%endif%}

        {% if form.facebook %}
        <div>
          <label for="id_facebook" class="block text-sm font-semibold mb-2">Business Facebook Link (Optional) – Display on your website if provided</label>
          {{ form.facebook }}
          {% if form.facebook.errors %}
            <p class="mt-2 text-sm text-red-600">{{ form.facebook.errors.0 }}</p>
          {% endif %}
        </div>
        {%endif%}

        {% if form.instagram %}
        <div>
          <label for="id_instagram" class="block text-sm font-semibold mb-2">Business Instagram Link (Optional) – Display on your website if provided</label>
          {{ form.instagram }}
          {% if form.instagram.errors %}
            <p class="mt-2 text-sm text-red-600">{{ form.instagram.errors.0 }}</p>
          {% endif %}
        </div>
        {%endif%}


        {% if form.linkedin %}
        <div>
          <label for="id_linkedin" class="block text-sm font-semibold mb-2">Business Linkedin Link (Optional) – Display on your website if provided</label>
          {{ form.linkedin }}
          {% if form.linkedin.errors %}
            <p class="mt-2 text-sm text-red-600">{{ form.linkedin.errors.0 }}</p>
          {% endif %}
        </div>
        {%endif%}

        <!-- Submit -->
        <div class="text-center pt-6">
          <button type="submit"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-10 rounded-lg shadow-md transition-all">
            Save & Continue
          </button>
        </div>
      </form>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      function setupImagePreview(inputId, previewId, noTextId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const noText = document.getElementById(noTextId);
  
        input.addEventListener('change', function(event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              preview.src = e.target.result;
              preview.classList.remove('hidden');
              if (noText) noText.classList.add('hidden');
            }
            reader.readAsDataURL(file);
          }
        });
      }
  
      // Initialize for both inputs
      setupImagePreview('{{ form.logo.id_for_label }}', 'logo-preview', 'no-logo-text');
      setupImagePreview('{{ form.business_picture.id_for_label }}', 'business-picture-preview', 'no-picture-text');
    });
  </script>
  
  <!-- ✅ Bank Verification Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const bankSelect = document.getElementById('id_bank');
      const acctInput = document.getElementById('id_account_no');
      const box = document.getElementById('account-name-box');
      const nameSpan = document.getElementById('resolved-account-name');
      const hiddenInput = document.getElementById('id_account_name');

      async function verifyAccount() {
        const bank = bankSelect.value;
        const acct = acctInput.value.trim();

        box.classList.add('hidden');
        nameSpan.textContent = "";

        if (!bank || acct.length !== 10) return;

        box.classList.remove('hidden');
        nameSpan.textContent = "Verifying...";

        try {
          const response = await fetch(`/verify-bank-account/?bank=${bank}&account_no=${acct}`);
          const data = await response.json();

          if (data.status === "success") {
            nameSpan.textContent = data.account_name;
            box.classList.remove('bg-red-50', 'border-red-500');
            box.classList.add('bg-green-50', 'border-green-500');
            hiddenInput.value = data.account_name;
          } else {
            nameSpan.textContent = "Invalid account details — please check your bank and account number.";
            box.classList.remove('bg-green-50', 'border-green-500');
            box.classList.add('bg-red-50', 'border-red-500');
            hiddenInput.value = "";

            acctInput.classList.add('ring-2', 'ring-red-500', 'border-red-500');
            setTimeout(() => {
              acctInput.classList.remove('ring-2', 'ring-red-500', 'border-red-500');
            }, 2500);
          }
        } catch (e) {
          nameSpan.textContent = "Error verifying account — please try again.";
          box.classList.add('bg-red-50', 'border-red-500');
        }
      }

      acctInput.addEventListener('input', verifyAccount);
      bankSelect.addEventListener('change', verifyAccount);
    });
  </script>
</body>

{% endblock %}
